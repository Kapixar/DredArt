/* eslint-disable no-prototype-builtins */
const rgb = [[222, 165, 164], [214, 145, 136], [173, 111, 105], [128, 64, 64], [77, 0, 0], [77, 25, 0], [128, 0, 0], [144, 30, 30], [186, 1, 1], [179, 54, 54], [179, 95, 54], [255, 0, 0], [216, 124, 99], [255, 64, 64], [255, 128, 128], [255, 195, 192], [195, 153, 83], [128, 85, 64], [128, 106, 64], [77, 51, 38], [77, 51, 0], [128, 42, 0], [155, 71, 3], [153, 101, 21], [213, 70, 0], [218, 99, 4], [255, 85, 0], [237, 145, 33], [255, 179, 31], [255, 128, 64], [255, 170, 128], [255, 212, 128], [181, 179, 92], [77, 64, 38], [77, 77, 0], [128, 85, 0], [179, 128, 7], [183, 162, 20], [179, 137, 54], [238, 230, 0], [255, 170, 0], [255, 204, 0], [255, 255, 0], [255, 191, 64], [255, 255, 64], [223, 190, 111], [255, 255, 128], [234, 218, 184], [199, 205, 144], [128, 128, 64], [77, 77, 38], [64, 77, 38], [128, 128, 0], [101, 114, 32], [141, 182, 0], [165, 203, 12], [179, 179, 54], [191, 201, 33], [206, 255, 0], [170, 255, 0], [191, 255, 64], [213, 255, 128], [248, 249, 156], [253, 254, 184], [135, 169, 107], [106, 128, 64], [85, 128, 64], [51, 77, 38], [51, 77, 0], [67, 106, 13], [85, 128, 0], [42, 128, 0], [103, 167, 18], [132, 222, 2], [137, 179, 54], [95, 179, 54], [85, 255, 0], [128, 255, 64], [170, 255, 128], [210, 248, 176], [143, 188, 143], [103, 146, 103], [64, 128, 64], [38, 77, 38], [25, 77, 0], [0, 77, 0], [0, 128, 0], [34, 139, 34], [3, 192, 60], [70, 203, 24], [54, 179, 54], [54, 179, 95], [0, 255, 0], [64, 255, 64], [119, 221, 119], [128, 255, 128], [64, 128, 85], [64, 128, 106], [38, 77, 51], [0, 77, 26], [0, 77, 51], [0, 128, 43], [23, 114, 69], [0, 171, 102], [28, 172, 120], [11, 218, 81], [0, 255, 85], [80, 200, 120], [64, 255, 128], [128, 255, 170], [128, 255, 212], [168, 227, 189], [110, 174, 161], [64, 128, 128], [38, 77, 64], [38, 77, 77], [0, 77, 77], [0, 128, 85], [0, 166, 147], [0, 204, 153], [0, 204, 204], [54, 179, 137], [54, 179, 179], [0, 255, 170], [0, 255, 255], [64, 255, 191], [64, 255, 255], [128, 255, 255], [133, 196, 204], [93, 138, 168], [64, 106, 128], [38, 64, 77], [0, 51, 77], [0, 128, 128], [0, 85, 128], [0, 114, 187], [8, 146, 208], [54, 137, 179], [33, 171, 205], [0, 170, 255], [100, 204, 219], [64, 191, 255], [128, 212, 255], [175, 238, 238], [64, 85, 128], [38, 51, 77], [0, 26, 77], [0, 43, 128], [0, 47, 167], [54, 95, 179], [40, 106, 205], [0, 127, 255], [0, 85, 255], [49, 140, 231], [73, 151, 208], [64, 128, 255], [113, 166, 210], [100, 149, 237], [128, 170, 255], [182, 209, 234], [146, 161, 207], [64, 64, 128], [38, 38, 77], [0, 0, 77], [25, 0, 77], [0, 0, 128], [42, 0, 128], [0, 0, 205], [54, 54, 179], [95, 54, 179], [0, 0, 255], [28, 28, 240], [106, 90, 205], [64, 64, 255], [133, 129, 217], [128, 128, 255], [177, 156, 217], [150, 123, 182], [120, 81, 169], [85, 64, 128], [106, 64, 128], [51, 38, 77], [51, 0, 77], [85, 0, 128], [137, 54, 179], [85, 0, 255], [138, 43, 226], [167, 107, 207], [127, 64, 255], [191, 64, 255], [148, 87, 235], [170, 128, 255], [153, 85, 187], [140, 100, 149], [128, 64, 128], [64, 38, 77], [77, 38, 77], [77, 0, 77], [128, 0, 128], [159, 0, 197], [179, 54, 179], [184, 12, 227], [170, 0, 255], [255, 0, 255], [255, 64, 255], [213, 128, 255], [255, 128, 255], [241, 167, 254], [128, 64, 106], [105, 45, 84], [77, 38, 64], [77, 0, 51], [128, 0, 85], [162, 0, 109], [179, 54, 137], [202, 31, 123], [255, 0, 170], [255, 29, 206], [233, 54, 167], [207, 107, 169], [255, 64, 191], [218, 112, 214], [255, 128, 213], [230, 168, 215], [145, 95, 109], [128, 64, 85], [77, 38, 51], [77, 0, 25], [128, 0, 42], [215, 0, 64], [179, 54, 95], [255, 0, 127], [255, 0, 85], [255, 0, 40], [222, 49, 99], [208, 65, 126], [215, 59, 62], [255, 64, 127], [249, 90, 97], [255, 128, 170], [17, 17, 17], [34, 34, 34], [51, 51, 51], [68, 68, 68], [85, 85, 85], [102, 102, 102], [119, 119, 119], [136, 136, 136], [153, 153, 153], [170, 170, 170], [187, 187, 187], [204, 204, 204], [221, 221, 221], [238, 238, 238], [255, 255, 255]];
const combos = rgbCombinations();
const combosFiltered = filterCombinations(combos);
console.log(combosFiltered);
console.log(combosFiltered.length);

onmessage = function (e) {
    // const { data } = e;
    // const newImgData = YliluomaOrdered1(data);
    // postMessage(newImgData);
};

const matrix = [
    [0, 1 / 2, 1 / 8, 5 / 8],
    [3 / 4, 1 / 4, 7 / 8, 3 / 8],
    [3 / 16, 11 / 16, 1 / 16, 9 / 16],
    [15 / 16, 7 / 16, 13 / 16, 5 / 16],
];

function YliluomaOrdered1(imgData) {
    const { data: sD, width: w, height: h } = imgData;
    const planDict = {};
    for (let y = 0; y < h; y++) {
        for (let x = 0; x < w; x++) {
            const i = pxIndex(x, y, w);
            const mapValue = matrix[x % 4][y % 4];
            const cStr = `${sD[i]};${sD[i + 1]};${sD[i + 2]}`;

            const plan = planDict.hasOwnProperty(cStr) ? planDict[cStr] : generatePlan(sD[i], sD[i + 1], sD[i + 2]);
            if (!planDict.hasOwnProperty(cStr)) planDict[cStr] = plan;
            const newColor = rgb[plan[mapValue < plan[2] ? 1 : 0]];

            [sD[i], sD[i + 1], sD[i + 2]] = [newColor[0], newColor[1], newColor[2]];
        }
    }
    console.log(Object.keys(planDict).length);
    return imgData;
}

function generatePlan(r, g, b) {
    let minPenalty = 1e99;
    let plan = [0, 0, 0.5];
    for (const [c1id, c2id] of combos) {
        let ratio = 0.5;
        if (c1id != c2id) {
            const r1 = rgb[c1id][0]; const g1 = rgb[c1id][1]; const b1 = rgb[c1id][2];
            const r2 = rgb[c2id][0]; const g2 = rgb[c2id][1]; const b2 = rgb[c2id][2];
            ratio = ((r2 != r1 ? 299 * (r - r1) / (r2 - r1) : 0)
                + (g2 != g1 ? 587 * (g - g1) / (g2 - g1) : 0)
                + (b1 != b2 ? 114 * (b - b1) / (b2 - b1) : 0))
                / ((r2 != r1 ? 299 : 0)
                    + (g2 != g1 ? 587 : 0)
                    + (b2 != b1 ? 114 : 0));
            if (ratio < 0) ratio = 0; else if (ratio > 1) ratio = 1;
        }
        const mix = mixRgb(rgb[c1id], rgb[c2id], ratio);
        const penalty = evaulateMixingError([r, g, b], mix, c1id, c2id, ratio);
        if (penalty < minPenalty) {
            minPenalty = penalty;
            plan = [c1id, c2id, ratio];
        }
    }
    return plan;
}

function pxIndex(x, y, w) {
    return (x + y * w) * 4;
}

function evaulateMixingError(search, mix, c1id, c2id, ratio) {
    return colorCompare(search, mix) + colorCompare(rgb[c2id], rgb[c1id]) * 0.1 * (Math.abs(ratio - 0.5) + 0.5);
}

function rgbCombinations() {
    // all unique combinations of numbers from 0 to 255 (so cant be 0, 255 and 255, 0 at the same time)
    let combinations = [];
    for (let i = 0; i < 255; i++) {
        for (let j = i; j < 255; j++) {
            combinations.push([i, j]);
        }
    }
    return combinations;
}

function mixRgb(c1, c2, ratio = .5) {
    // const r = Math.round(c1[0] * ratio + c2[0] * (1 - ratio));
    // const g = Math.round(c1[1] * ratio + c2[1] * (1 - ratio));
    // const b = Math.round(c1[2] * ratio + c2[2] * (1 - ratio));
    const r = Math.round(c1[0] + ratio * (c2[0]- c1[0]));
    const g = Math.round(c1[1] + ratio * (c2[1]- c1[1]));
    const b = Math.round(c1[2] + ratio * (c2[2]- c1[2]));
    return [r, g, b];
}

function colorCompare(c1, c2) {
    const luma1 = (c1[0] * 299 + c1[1] * 587 + c1[2] * 114) / (255000);
    const luma2 = (c2[0] * 299 + c2[1] * 587 + c2[2] * 114) / (255000);
    const lumadiff = luma1 - luma2;
    const diffR = (c1[0] - c2[0]) / 255, diffG = (c1[1] - c2[1]) / 255, diffB = (c1[2] - c2[2]) / 255;
    return (diffR * diffR * .299 + diffG * diffG * .587 + diffB * diffB * .114) * .75
        + lumadiff * lumadiff;

}


function luminance(r, g, b) {
    return 0.299 * r + 0.587 * g + 0.114 * b;
}

// Filter the combinations based on the luminance difference condition
function filterCombinations(combinations) {
    let maxDiff = 0.125;
    for (const comboo of combinations) {
        const luminances = comboo.map((colorId) => luminance(rgb[colorId][0], rgb[colorId][1], rgb[colorId][2]));
        console.log(luminances);
        maxDiff = Math.max(...luminances);
    }
    console.log(maxDiff);
    return combinations.filter((combination) => {
        const luminances = combination.map((colorId) => luminance(rgb[colorId][0], rgb[colorId][1], rgb[colorId][2]));
        return (Math.max(...luminances) - Math.min(...luminances)) < 2.76 * maxDiff;
    });
}
